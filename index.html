<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Space Defender: Pro Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #020617;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: none;
            user-select: none;
        }
        canvas { display: block; }
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; color: white; padding: 20px;
            display: flex; flex-direction: column; justify-content: space-between;
            box-sizing: border-box; z-index: 10;
        }
        .menu-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(2, 6, 23, 0.9); display: flex; flex-direction: column;
            align-items: center; justify-content: center; pointer-events: all; z-index: 50;
        }
        .btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            padding: 12px 30px; border-radius: 50px; font-size: 1.2rem; font-weight: bold;
            cursor: pointer; transition: all 0.2s; border: none; color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.5);
        }
        .btn:hover { transform: scale(1.05); filter: brightness(1.1); }
        
        #skin-shop {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #0f172a; border: 2px solid #3b82f6; border-radius: 24px;
            padding: 24px; width: 90%; max-width: 500px; max-height: 80vh;
            z-index: 100; display: none; pointer-events: all;
            box-shadow: 0 0 40px rgba(59, 130, 246, 0.4);
            overflow-y: auto;
        }
        .shop-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px; padding: 16px; margin-bottom: 16px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        .texture-preview {
            width: 50px; height: 50px; border-radius: 8px;
            background: #1e293b; border: 1px solid #3b82f6;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; font-size: 20px;
        }
        .texture-preview img { width: 100%; height: 100%; object-fit: contain; }
        
        .upload-btn {
            background: #1e293b; color: #93c5fd; border: 1px dashed #3b82f6;
            padding: 4px 12px; border-radius: 6px; font-size: 0.75rem; cursor: pointer;
        }
        .upload-btn:hover { background: #334155; }
        
        .score-val { font-size: 2rem; font-weight: 800; text-shadow: 0 0 10px #3b82f6; }
        #progress-container {
            position: absolute; left: 20px; top: 50%; transform: translateY(-50%);
            width: 12px; height: 150px; background: rgba(255, 255, 255, 0.1);
            border-radius: 6px; overflow: hidden;
        }
        #progress-bar { position: absolute; bottom: 0; width: 100%; height: 0%; background: #3b82f6; transition: height 0.3s; }
        
        #cooldown-ui {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 100px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px;
            overflow: hidden; pointer-events: none;
        }
        #cooldown-bar { height: 100%; width: 100%; background: #fbbf24; transition: width 0.05s linear; }

        .currency-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.3);
            padding: 4px 12px;
            border-radius: 12px;
            margin-bottom: 4px;
        }

        #announcement {
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
            font-size: 3rem; font-weight: 900; color: #fbbf24; text-shadow: 0 0 20px #b45309;
            pointer-events: none; display: none; text-align: center; z-index: 60;
        }
    </style>
</head>
<body id="game-container">

<div id="ui-layer">
    <div class="flex justify-between items-start w-full">
        <div class="pointer-events-auto">
            <div id="score" class="score-val">0</div>
            <div class="currency-badge">
                <span id="money" class="text-lg font-bold text-yellow-400">0 ü™ô</span>
            </div>
            <div class="currency-badge">
                <span id="gems" class="text-lg font-bold text-cyan-400">0 üíé</span>
            </div>
        </div>
        <div class="flex flex-col gap-2 pointer-events-auto">
            <button class="btn !py-2 !px-6 !text-sm" onclick="toggleShop()">–ú–ê–ì–ê–ó–ò–ù –°–ö–Ü–ù–Ü–í üé®</button>
        </div>
        <div class="text-right">
            <div id="lives" class="score-val text-red-500">‚ù§‚ù§‚ù§</div>
        </div>
    </div>
    <div id="progress-container"><div id="progress-bar"></div></div>
    <div id="cooldown-ui"><div id="cooldown-bar"></div></div>
</div>

<div id="announcement">BOSS INCOMING!</div>

<div id="skin-shop">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-2xl font-black text-blue-400">–°–ö–Ü–ù-–¶–ï–ù–¢–†</h2>
            <p class="text-cyan-400 text-sm font-bold">–ë–∞–ª–∞–Ω—Å: <span id="shop-gems">0</span> üíé</p>
        </div>
        <button onclick="toggleShop()" class="text-gray-400 hover:text-white">‚úï</button>
    </div>
    
    <div class="shop-section">
        <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-3">
                <div id="prev-player" class="texture-preview">üöÄ</div>
                <div><h3 class="font-bold text-sm">–ö–æ—Ä–∞–±–µ–ª—å –ì—Ä–∞–≤—Ü—è</h3></div>
            </div>
            <label class="upload-btn">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏<input type="file" class="hidden" accept="image/*" onchange="uploadSkin(event, 'player')"></label>
        </div>
        <button onclick="resetSkin('player')" class="text-[10px] text-red-400 hover:underline">–°–∫–∏–Ω—É—Ç–∏</button>
    </div>

    <div class="shop-section">
        <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-3">
                <div id="prev-stalker" class="texture-preview">üëæ</div>
                <div><h3 class="font-bold text-sm">–°—Ç–∞–ª–∫–µ—Ä–∏</h3></div>
            </div>
            <label class="upload-btn">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏<input type="file" class="hidden" accept="image/*" onchange="uploadSkin(event, 'stalker')"></label>
        </div>
        <button onclick="resetSkin('stalker')" class="text-[10px] text-red-400 hover:underline">–°–∫–∏–Ω—É—Ç–∏</button>
    </div>

    <div class="shop-section">
        <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-3">
                <div id="prev-meteor" class="texture-preview">üåë</div>
                <div><h3 class="font-bold text-sm">–ú–µ—Ç–µ–æ—Ä–∏—Ç–∏</h3></div>
            </div>
            <label class="upload-btn">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏<input type="file" class="hidden" accept="image/*" onchange="uploadSkin(event, 'meteor')"></label>
        </div>
        <button onclick="resetSkin('meteor')" class="text-[10px] text-red-400 hover:underline">–°–∫–∏–Ω—É—Ç–∏</button>
    </div>

    <div class="shop-section">
        <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-3">
                <div id="prev-map" class="texture-preview">üåå</div>
                <div><h3 class="font-bold text-sm">–ú–∞–ø–∞ (–§–æ–Ω)</h3></div>
            </div>
            <label class="upload-btn">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏<input type="file" class="hidden" accept="image/*" onchange="uploadSkin(event, 'map')"></label>
        </div>
        <button onclick="resetSkin('map')" class="text-[10px] text-red-400 hover:underline">–°–∫–∏–Ω—É—Ç–∏</button>
    </div>

    <button class="w-full bg-blue-600 py-3 rounded-xl font-bold mt-2" onclick="toggleShop()">–ó–ë–ï–†–ï–ì–¢–ò</button>
</div>

<div id="start-menu" class="menu-overlay">
    <h1 class="text-6xl font-black mb-8 text-blue-500 tracking-tighter text-center">SPACE DEFENDER</h1>
    <button class="btn" onclick="startGame()">–ì–†–ê–¢–ò</button>
</div>

<div id="game-over-menu" class="menu-overlay" style="display: none;">
    <h1 class="text-5xl font-black mb-4 text-red-500">–ì–†–ê –ó–ê–ö–Ü–ù–ß–ï–ù–ê</h1>
    <button class="btn" onclick="startGame()">–†–ï–í–ê–ù–®</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const shopUI = document.getElementById('skin-shop');
    const progressBar = document.getElementById('progress-bar');
    const cdBar = document.getElementById('cooldown-bar');
    const announcement = document.getElementById('announcement');
    
    let gameActive = false, score = 0, money = 0, gems = 0, lives = 3;
    let player, bullets, enemyBullets, enemies, stars, stalkers, bosses;
    let keys = {}, isMouseDown = false;
    let bossSpawned = false;
    
    const SHOOT_COOLDOWN_MS = 400;
    const SCORE_TO_BOSS = 1000;

    const skins = {
        player: { img: null, preview: 'üöÄ' },
        stalker: { img: null, preview: 'üëæ' },
        meteor: { img: null, preview: 'üåë' },
        map: { img: null, preview: 'üåå' }
    };

    function resize() {
        const oldW = canvas.width;
        const oldH = canvas.height;
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // Keep player in bounds after resize and maintain relative position
        if (player) {
            const xRatio = player.x / (oldW || canvas.width);
            const yRatio = player.y / (oldH || canvas.height);
            player.x = canvas.width * xRatio;
            player.y = canvas.height * yRatio;
            player.clamp();
        }
    }
    window.addEventListener('resize', resize);
    resize();

    function uploadSkin(event, type) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                skins[type].img = img;
                document.getElementById(`prev-${type}`).innerHTML = `<img src="${e.target.result}">`;
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function resetSkin(type) {
        skins[type].img = null;
        const emojis = { player: 'üöÄ', stalker: 'üëæ', meteor: 'üåë', map: 'üåå' };
        document.getElementById(`prev-${type}`).innerHTML = emojis[type];
    }

    function toggleShop() {
        shopUI.style.display = (shopUI.style.display === 'block') ? 'none' : 'block';
        document.getElementById('shop-gems').innerText = gems;
    }

    class Player {
        constructor() {
            this.w = 50; this.h = 50;
            this.x = canvas.width/2; this.y = canvas.height-100;
            this.speed = 6;
            this.lastShot = 0;
        }
        draw() {
            ctx.save();
            ctx.translate(this.x, this.y);
            if (skins.player.img) {
                ctx.drawImage(skins.player.img, -this.w/2, -this.h/2, this.w, this.h);
            } else {
                ctx.fillStyle = '#3b82f6'; ctx.beginPath();
                ctx.moveTo(0, -25); ctx.lineTo(-20, 20); ctx.lineTo(20, 20); ctx.fill();
            }
            ctx.restore();
        }
        clamp() {
            this.x = Math.max(this.w/2, Math.min(canvas.width - this.w/2, this.x));
            this.y = Math.max(this.h/2, Math.min(canvas.height - this.h/2, this.y));
        }
        update() {
            if (keys['KeyA'] || keys['ArrowLeft']) this.x -= this.speed;
            if (keys['KeyD'] || keys['ArrowRight']) this.x += this.speed;
            if (keys['KeyW'] || keys['ArrowUp']) this.y -= this.speed;
            if (keys['KeyS'] || keys['ArrowDown']) this.y += this.speed;
            
            this.clamp();

            const now = Date.now();
            const elapsed = now - this.lastShot;
            const cdPercent = Math.min(100, (elapsed / SHOOT_COOLDOWN_MS) * 100);
            cdBar.style.width = cdPercent + '%';

            if (isMouseDown && elapsed >= SHOOT_COOLDOWN_MS) {
                bullets.push(new Bullet(this.x, this.y - 20));
                this.lastShot = now;
            }
        }
    }

    class Boss {
        constructor() {
            this.x = canvas.width/2; this.y = -100;
            this.w = 120; this.h = 100;
            this.health = 20;
            this.speed = 2;
            this.targetY = 150;
            this.shootTimer = 0;
            this.destroyed = false;
        }
        draw() {
            ctx.save();
            ctx.translate(this.x, this.y);
            // Health Bar
            ctx.fillStyle = '#1e293b'; ctx.fillRect(-60, -70, 120, 10);
            ctx.fillStyle = '#ef4444'; ctx.fillRect(-60, -70, (this.health/20)*120, 10);
            
            ctx.fillStyle = '#7c3aed';
            ctx.beginPath();
            ctx.moveTo(0, 50); ctx.lineTo(-60, -50); ctx.lineTo(60, -50);
            ctx.fill();
            ctx.restore();
        }
        update() {
            if (this.y < this.targetY) this.y += this.speed;
            this.x += Math.sin(Date.now()/500) * 3;
            
            if (++this.shootTimer > 40) {
                enemyBullets.push(new EnemyBullet(this.x - 30, this.y + 40));
                enemyBullets.push(new EnemyBullet(this.x, this.y + 40));
                enemyBullets.push(new EnemyBullet(this.x + 30, this.y + 40));
                this.shootTimer = 0;
            }
        }
    }

    class Stalker {
        constructor() {
            this.x = Math.random() * canvas.width; this.y = -50;
            this.w = 40; this.h = 40;
            this.speed = player.speed * 0.37;
            this.shootTimer = 0;
            this.destroyed = false;
        }
        draw() {
            ctx.save();
            ctx.translate(this.x, this.y);
            if (skins.stalker.img) {
                ctx.drawImage(skins.stalker.img, -this.w/2, -this.h/2, this.w, this.h);
            } else {
                ctx.fillStyle = '#ef4444'; ctx.beginPath();
                ctx.moveTo(0, 15); ctx.lineTo(-15, -15); ctx.lineTo(15, -15); ctx.fill();
            }
            ctx.restore();
        }
        update() {
            this.y = Math.min(this.y + 2, 100);
            const dx = player.x - this.x;
            this.x += Math.sign(dx) * Math.min(Math.abs(dx), this.speed);
            if (++this.shootTimer > 90) {
                enemyBullets.push(new EnemyBullet(this.x, this.y + 20));
                this.shootTimer = 0;
            }
        }
    }

    class Enemy {
        constructor() {
            this.r = 20 + Math.random() * 20;
            this.x = Math.random() * canvas.width; this.y = -this.r;
            this.speed = player.speed * 0.37;
            this.rotation = 0;
            this.rotSpeed = (Math.random() - 0.5) * 0.05;
            this.destroyed = false;
            this.vertices = [];
            const points = 7 + Math.floor(Math.random() * 5);
            for(let i=0; i<points; i++) {
                const angle = (i / points) * Math.PI * 2;
                const dist = this.r * (0.7 + Math.random() * 0.4);
                this.vertices.push({x: Math.cos(angle) * dist, y: Math.sin(angle) * dist});
            }
        }
        draw() {
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.rotate(this.rotation);
            if (skins.meteor.img) {
                ctx.drawImage(skins.meteor.img, -this.r, -this.r, this.r*2, this.r*2);
            } else {
                ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 2; ctx.fillStyle = '#1e293b';
                ctx.beginPath();
                ctx.moveTo(this.vertices[0].x, this.vertices[0].y);
                for(let v of this.vertices) ctx.lineTo(v.x, v.y);
                ctx.closePath(); ctx.fill(); ctx.stroke();
            }
            ctx.restore();
        }
        update() { 
            this.y += this.speed; 
            this.rotation += this.rotSpeed;
            if (this.y > canvas.height + 50) this.destroyed = true;
        }
    }

    class Bullet {
        constructor(x, y) { this.x = x; this.y = y; this.speed = 12; this.r = 4; this.destroyed = false; }
        draw() { 
            ctx.fillStyle = '#fbbf24'; ctx.shadowBlur = 10; ctx.shadowColor = '#fbbf24';
            ctx.beginPath(); ctx.arc(this.x, this.y, this.r, 0, Math.PI*2); ctx.fill();
            ctx.shadowBlur = 0;
        }
        update() { this.y -= this.speed; if (this.y < -20) this.destroyed = true; }
    }

    class EnemyBullet {
        constructor(x, y) { this.x = x; this.y = y; this.speed = 7; this.r = 4; this.destroyed = false; }
        draw() { ctx.fillStyle = '#f87171'; ctx.beginPath(); ctx.arc(this.x, this.y, this.r, 0, Math.PI*2); ctx.fill(); }
        update() { this.y += this.speed; if (this.y > canvas.height + 20) this.destroyed = true; }
    }

    function init() {
        player = new Player();
        bullets = []; enemyBullets = []; enemies = []; stalkers = []; bosses = [];
        stars = Array.from({length: 150}, () => ({
            x: Math.random() * canvas.width, y: Math.random() * canvas.height,
            s: 0.5 + Math.random() * 2, opacity: 0.1 + Math.random() * 0.9,
            fade: (Math.random() * 0.02) * (Math.random() > 0.5 ? 1 : -1)
        }));
        score = 0; money = 0; lives = 3; bossSpawned = false;
        updateUI();
    }

    function updateUI() {
        document.getElementById('score').innerText = score;
        document.getElementById('money').innerText = `${money} ü™ô`;
        document.getElementById('gems').innerText = `${gems} üíé`;
        document.getElementById('lives').innerText = '‚ù§'.repeat(Math.max(0, lives));
        progressBar.style.height = Math.min(100, (score/SCORE_TO_BOSS)*100) + '%';
    }

    function startGame() {
        init(); gameActive = true;
        document.getElementById('start-menu').style.display = 'none';
        document.getElementById('game-over-menu').style.display = 'none';
        requestAnimationFrame(gameLoop);
    }

    function gameOver() {
        gameActive = false;
        document.getElementById('game-over-menu').style.display = 'flex';
    }

    window.addEventListener('keydown', e => keys[e.code] = true);
    window.addEventListener('keyup', e => keys[e.code] = false);
    window.addEventListener('mousedown', () => isMouseDown = true);
    window.addEventListener('mouseup', () => isMouseDown = false);
    window.addEventListener('touchstart', (e) => { isMouseDown = true; e.preventDefault(); }, {passive: false});
    window.addEventListener('touchend', () => isMouseDown = false);

    function gameLoop() {
        if (!gameActive) return;
        
        if (skins.map.img) {
            ctx.drawImage(skins.map.img, 0, 0, canvas.width, canvas.height);
        } else {
            ctx.fillStyle = '#020617'; ctx.fillRect(0,0, canvas.width, canvas.height);
        }

        stars.forEach(s => {
            s.opacity += s.fade;
            if (s.opacity > 1 || s.opacity < 0.1) s.fade *= -1;
            ctx.fillStyle = `rgba(255, 255, 255, ${s.opacity})`;
            ctx.beginPath(); ctx.arc(s.x, s.y, s.s, 0, Math.PI * 2); ctx.fill();
            s.y += s.s * 0.5;
            if(s.y > canvas.height) { s.y = -10; s.x = Math.random() * canvas.width; }
        });

        if (score >= SCORE_TO_BOSS && !bossSpawned) {
            bossSpawned = true;
            announcement.style.display = 'block';
            setTimeout(() => { announcement.style.display = 'none'; bosses.push(new Boss()); }, 2000);
        }

        player.update(); player.draw();

        if (bosses.length === 0) {
            if (Math.random() < 0.012) enemies.push(new Enemy());
            if (Math.random() < 0.0018 && stalkers.length < 3) stalkers.push(new Stalker());
        }

        bullets.forEach(b => { b.update(); b.draw(); });
        enemyBullets.forEach(eb => { 
            eb.update(); eb.draw(); 
            if (Math.hypot(player.x - eb.x, player.y - eb.y) < 20) {
                eb.destroyed = true; lives--; updateUI();
                if (lives <= 0) gameOver();
            }
        });

        bosses.forEach(b => {
            b.update(); b.draw();
            bullets.forEach(bul => {
                if (Math.hypot(bul.x - b.x, bul.y - b.y) < 60) {
                    bul.destroyed = true; b.health--;
                    if (b.health <= 0) {
                        b.destroyed = true;
                        gems += 1;
                        score = 0;
                        bossSpawned = false;
                        updateUI();
                    }
                }
            });
        });

        enemies.forEach(en => {
            en.update(); en.draw();
            if (Math.hypot(player.x - en.x, player.y - en.y) < en.r + 15) {
                en.destroyed = true; lives--; updateUI();
                if (lives <= 0) gameOver();
            }
            bullets.forEach(b => {
                if (Math.hypot(b.x - en.x, b.y - en.y) < en.r) {
                    en.destroyed = true; b.destroyed = true;
                    score += 10; money += 5; updateUI();
                }
            });
        });

        stalkers.forEach(st => {
            st.update(); st.draw();
            bullets.forEach(b => {
                if (Math.hypot(b.x - st.x, b.y - st.y) < 25) {
                    st.destroyed = true; b.destroyed = true;
                    score += 50; money += 20; updateUI();
                }
            });
        });

        bullets = bullets.filter(b => !b.destroyed);
        enemyBullets = enemyBullets.filter(eb => !eb.destroyed);
        enemies = enemies.filter(en => !en.destroyed);
        stalkers = stalkers.filter(st => !st.destroyed);
        bosses = bosses.filter(b => !b.destroyed);

        requestAnimationFrame(gameLoop);
    }
</script>
</body>
</html>